---
phase: 04-environmental-interaction
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/omega-core/src/simulation/environmental.rs
  - crates/omega-core/src/simulation/mod.rs
autonomous: true

must_haves:
  truths:
    - "Liquids flow downward into empty cells one cell per tick (no teleportation)"
    - "Liquids spread horizontally when blocked below, equalizing across containers"
    - "Steam and Smoke rise upward one cell per tick"
    - "Gas spreads horizontally when blocked by ceiling/solid above"
    - "Gas dissipates gradually when trapped with no room to move"
    - "Fire spread uses directional bias (upward stronger than downward)"
  artifacts:
    - path: "crates/omega-core/src/simulation/environmental.rs"
      provides: "Liquid flow, gas rise, gas dissipation, fire spread refinement"
      exports: ["apply_liquid_flow", "apply_gas_rise", "apply_fire_spread_bias"]
    - path: "crates/omega-core/src/simulation/mod.rs"
      provides: "environmental module registration"
      contains: "pub mod environmental"
  key_links:
    - from: "crates/omega-core/src/simulation/environmental.rs"
      to: "crates/omega-core/src/simulation/grid.rs"
      via: "CaGrid get/set/in_bounds API"
      pattern: "grid\\.(get|set|in_bounds|width|height)"
    - from: "crates/omega-core/src/simulation/environmental.rs"
      to: "crates/omega-core/src/simulation/cell.rs"
      via: "Cell fields: solid, liquid, gas, heat, wet, pressure"
      pattern: "cell\\.(solid|liquid|gas|heat|wet|pressure)"
---

<objective>
Implement the three environmental CA behavior functions: liquid flow (ENV-02), gas diffusion (ENV-03), and fire spread directional bias refinement (ENV-01). These are pure functions operating on CaGrid, tested via TDD.

Purpose: Provide the movement rules that make the simulation world feel alive — water pools, steam rises, fire climbs.
Output: `environmental.rs` with `apply_liquid_flow`, `apply_gas_rise`, `apply_fire_spread_bias` functions, fully unit tested.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-environmental-interaction/04-RESEARCH.md
@crates/omega-core/src/simulation/mod.rs
@crates/omega-core/src/simulation/grid.rs
@crates/omega-core/src/simulation/cell.rs
@crates/omega-core/src/simulation/state.rs
@crates/omega-core/src/simulation/neighborhood.rs
@crates/omega-core/src/simulation/reactions.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement liquid flow with bottom-up scan (ENV-02)</name>
  <files>crates/omega-core/src/simulation/environmental.rs</files>
  <action>
Create `environmental.rs` in `crates/omega-core/src/simulation/`.

Implement `pub fn apply_liquid_flow(grid: &mut CaGrid)` using bottom-up scanning (y from height-1 down to 0) to prevent teleportation artifacts.

**Flow priority order (falling sand pattern):**
1. **Down:** If cell below is empty (no solid, no liquid), transfer liquid to cell below. Use `grid.get()` to read front buffer, `grid.set()` to write back buffer.
2. **Diagonal down:** If directly down is blocked, try diagonal-down neighbors. Randomize left/right check order using `(x + y) % 2` parity to prevent directional bias. Only flow diagonally if the diagonal cell has no solid blocking AND the cell directly beside (horizontal) also has no solid (liquid can't flow through walls diagonally).
3. **Horizontal spread:** If all downward paths blocked, spread horizontally to empty neighbors. This creates pooling behavior. Only spread if the neighbor cell has no liquid and no solid.

**State transfer rules:**
- When liquid moves: set source cell's `liquid` to `None`, set destination cell's `liquid` to `Some(liquid_type)`. Transfer `wet` value proportionally.
- When liquid spreads horizontally: this is partial transfer. Source keeps its liquid, destination gets liquid. Both cells end up with liquid.
- Earth Anchoring: Solids block flow. Liquids cannot displace solids.
- Single liquid per cell: If destination already has liquid, skip it.

**Important implementation details:**
- Read from front buffer via `grid.get()`, write to back buffer via `grid.set()`.
- Since this modifies the back buffer and reads front, a cell moved in row Y won't be processed again when row Y-1 is scanned (bottom-up prevents this).
- Handle grid boundaries with `grid.in_bounds()` before accessing neighbors.
- Use `usize` carefully with subtraction (wrapping_sub or check > 0 before subtracting).

Write RED tests first for:
- Liquid falls one cell down per call (not multiple)
- Liquid flows diagonally when blocked directly below
- Liquid spreads horizontally when fully blocked below
- Liquid does not flow through/into solid cells
- Liquid does not overwrite existing liquid in destination
- Empty grid produces no changes

Run `cargo test -p omega-core` — tests MUST fail (RED phase).
Then implement the function. Run tests again — they MUST pass (GREEN phase).
  </action>
  <verify>`cargo test -p omega-core --lib simulation::environmental` — all liquid flow tests pass</verify>
  <done>Liquid flows down one cell per tick, spreads diagonally and horizontally when blocked, respects solids, no teleportation</done>
</task>

<task type="auto">
  <name>Task 2: Implement gas rise with top-down scan and dissipation (ENV-03)</name>
  <files>crates/omega-core/src/simulation/environmental.rs</files>
  <action>
In the same `environmental.rs`, implement:

**`pub fn apply_gas_rise(grid: &mut CaGrid)`** using top-down scanning (y from 0 to height) to prevent upward teleportation.

**Rise priority order:**
1. **Up:** If cell above is empty (no solid, no gas), transfer gas upward. Only Steam and Smoke rise. Fire (Gas::Fire) does NOT rise — it stays in place and spreads via heat diffusion (already handled by Phase 1).
2. **Diagonal up:** If directly up is blocked, try diagonal-up neighbors. Randomize with `(x + y) % 2` parity.
3. **Horizontal spread when ceiling-blocked:** If at top edge (y == 0) or solid above, spread horizontally to empty neighbors with reduced pressure.

**Dissipation rules:**
- When gas cannot move in any direction, reduce its `pressure` by 5 per tick.
- When `pressure` drops below 10, remove the gas entirely (`cell.gas = None`).
- When spreading horizontally under a ceiling, halve pressure between source and destination.

**State transfer rules:**
- Gas moves: source `gas` -> `None`, destination `gas` -> `Some(gas_type)`.
- Transfer `pressure` to destination, reduce source pressure when spreading.
- Gas cannot occupy a cell with an existing gas (single gas per cell per research recommendation).
- Gas can coexist over liquids (check `solid.is_none()` for passability, NOT `liquid.is_none()`).

**Also implement `pub fn apply_fire_spread_bias(grid: &mut CaGrid)`:**
- Iterate all cells. For each cell with a combustible solid (`can_ignite()`), check Moore neighbors for Fire gas.
- Apply directional heat bias: fire below the cell adds 30 heat (fire rises), fire beside adds 20 heat, fire above adds 10 heat.
- This supplements Phase 1's existing uniform heat diffusion with directional preference.
- Use `MOORE_OFFSETS` to determine direction. Offsets with dy < 0 mean fire is above current cell. Offsets with dy > 0 mean fire is below current cell.
- IMPORTANT: dy > 0 offset means neighbor is BELOW, and fire from below heats MORE (multiplier 30) because fire rises. dy < 0 means neighbor is ABOVE (multiplier 10). dy == 0 means same row (multiplier 20).

Write RED tests first for:
- Steam rises one cell per call
- Smoke rises one cell per call
- Fire does NOT rise (stays in place)
- Gas spreads horizontally when ceiling-blocked
- Gas dissipates when fully trapped (pressure decreases, eventually removed)
- Gas can rise through cells containing liquid (but not solid)
- Fire spread bias: fire below a combustible cell adds more heat than fire above

Run `cargo test -p omega-core` — tests MUST fail first, then pass after implementation.
  </action>
  <verify>`cargo test -p omega-core --lib simulation::environmental` — all gas and fire spread tests pass</verify>
  <done>Steam/Smoke rise upward, spread under ceilings, dissipate when trapped. Fire spread has vertical bias. All tests green.</done>
</task>

</tasks>

<verification>
- `cargo test -p omega-core` — all tests pass (existing + new environmental tests)
- `cargo check -p omega-core` — no compilation errors
- Environmental module registered in `mod.rs` with `pub mod environmental`
- Functions exported: `apply_liquid_flow`, `apply_gas_rise`, `apply_fire_spread_bias`
</verification>

<success_criteria>
- Liquid flow tests prove bottom-up scanning prevents teleportation (1 cell movement per call)
- Gas rise tests prove top-down scanning prevents teleportation
- Gas dissipation tests prove trapped gas eventually disappears
- Fire directional bias tests prove upward heat transfer is stronger
- All existing Phase 1 tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-environmental-interaction/04-01-SUMMARY.md`
</output>
