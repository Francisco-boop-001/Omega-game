---
phase: 04-environmental-interaction
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - crates/omega-bevy/src/simulation/systems.rs
  - crates/omega-bevy/src/simulation/plugin.rs
autonomous: true

must_haves:
  truths:
    - "Environmental behaviors run every FixedUpdate tick at 64Hz"
    - "Environmental systems execute after process_explosions and before swap_ca_buffers"
    - "Fire spread bias runs before liquid flow, liquid flow runs before gas rise"
    - "Existing simulation systems remain unaffected"
  artifacts:
    - path: "crates/omega-bevy/src/simulation/systems.rs"
      provides: "environmental_behaviors Bevy system function"
      exports: ["environmental_behaviors"]
    - path: "crates/omega-bevy/src/simulation/plugin.rs"
      provides: "environmental_behaviors scheduled in FixedUpdate chain"
      contains: "environmental_behaviors"
  key_links:
    - from: "crates/omega-bevy/src/simulation/systems.rs"
      to: "crates/omega-core/src/simulation/environmental.rs"
      via: "imports apply_liquid_flow, apply_gas_rise, apply_fire_spread_bias"
      pattern: "use omega_core::simulation::environmental"
    - from: "crates/omega-bevy/src/simulation/plugin.rs"
      to: "crates/omega-bevy/src/simulation/systems.rs"
      via: "environmental_behaviors in FixedUpdate .chain()"
      pattern: "environmental_behaviors"
---

<objective>
Wire the Phase 4 environmental behavior functions into Bevy's FixedUpdate pipeline as a single system that runs after explosions but before buffer swap.

Purpose: Make the environmental behaviors live in the simulation — every tick, liquids flow, gases rise, and fire spreads directionally.
Output: `environmental_behaviors` system function integrated into SimulationPlugin's FixedUpdate chain.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-environmental-interaction/04-01-SUMMARY.md
@crates/omega-bevy/src/simulation/systems.rs
@crates/omega-bevy/src/simulation/plugin.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environmental_behaviors Bevy system</name>
  <files>crates/omega-bevy/src/simulation/systems.rs</files>
  <action>
Add the `environmental_behaviors` system function to `systems.rs`.

Add the import at the top of the file:
```rust
use omega_core::simulation::environmental::{apply_liquid_flow, apply_gas_rise, apply_fire_spread_bias};
```

Add the system function:
```rust
pub fn environmental_behaviors(mut grid: ResMut<CaGrid>) {
    // Order matters: fire affects heat -> heat affects liquid evaporation -> gas rises from evaporation
    apply_fire_spread_bias(&mut grid);  // ENV-01: directional fire heat bias
    apply_liquid_flow(&mut grid);       // ENV-02: bottom-up liquid movement
    apply_gas_rise(&mut grid);          // ENV-03: top-down gas movement
}
```

This is a simple wiring function — all logic lives in omega-core's `environmental.rs`. The system takes `ResMut<CaGrid>` (same pattern as `update_ca_cells` and `process_explosions`).

The internal ordering is:
1. Fire spread bias first — adds directional heat that may trigger evaporation in the next core update cycle.
2. Liquid flow second — moves liquids. Any steam generated by evaporation from heat will be handled in gas rise.
3. Gas rise third — moves steam/smoke upward, handles dissipation.
  </action>
  <verify>`cargo check -p omega-bevy` compiles without errors</verify>
  <done>environmental_behaviors system function exists in systems.rs, imports and calls all three environmental functions</done>
</task>

<task type="auto">
  <name>Task 2: Schedule environmental_behaviors in FixedUpdate pipeline</name>
  <files>crates/omega-bevy/src/simulation/plugin.rs</files>
  <action>
In `plugin.rs`, add `environmental_behaviors` to the FixedUpdate system chain in `SimulationPlugin::build()`.

Insert it between `process_explosions` and `swap_ca_buffers` in the existing `.chain()`:

```rust
.add_systems(
    FixedUpdate,
    (
        increment_tick,
        particle_physics_system,
        particle_wind_drift_system,
        particle_lifecycle_system,
        particle_visual_cascade_system,
        trail_emitter_system,
        explosion_emitter_system,
        projectile_movement_system,
        projectile_collision_system,
        projectile_interception_system,
        update_ca_cells,
        process_explosions,
        environmental_behaviors,    // NEW: Phase 4 environmental movement
        swap_ca_buffers,
    )
        .chain(),
);
```

The positioning is critical:
- AFTER `update_ca_cells`: Core reactions/transitions already computed (heat diffusion, state changes).
- AFTER `process_explosions`: Explosive displacement already resolved (gas/heat pushed to neighbors).
- BEFORE `swap_ca_buffers`: Environmental writes go to back buffer, which is then swapped to front for next frame.

Verify that the existing `test_plugin_registration` test still passes after this change.
  </action>
  <verify>`cargo test -p omega-bevy` — all tests pass including plugin_registration. `cargo check -p omega-bevy` compiles clean.</verify>
  <done>environmental_behaviors runs in FixedUpdate after explosions and before buffer swap. Existing tests unbroken.</done>
</task>

</tasks>

<verification>
- `cargo check -p omega-bevy` — clean compilation
- `cargo test -p omega-bevy` — all tests pass (existing + any new)
- `cargo test -p omega-core` — all tests pass (no regressions from integration)
- System ordering: `update_ca_cells -> process_explosions -> environmental_behaviors -> swap_ca_buffers`
</verification>

<success_criteria>
- Environmental behaviors execute every tick at 64Hz within the FixedUpdate schedule
- System ordering preserved: core reactions -> explosions -> environmental movement -> buffer swap
- No regressions in existing simulation tests
- Clean compilation across both crates
</success_criteria>

<output>
After completion, create `.planning/phases/04-environmental-interaction/04-02-SUMMARY.md`
</output>
