---
phase: 01-core-elemental-system
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - crates/omega-core/src/simulation/wind.rs
  - crates/omega-core/src/simulation/displacement.rs
  - crates/omega-core/src/simulation/decay.rs
  - crates/omega-core/src/simulation/mod.rs
autonomous: true

must_haves:
  truths:
    - "Wind pushes Gas and Heat values in its direction"
    - "Explosive reactions displace Heat, Pressure, and Gas into neighbors in a single frame"
    - "Explosive displacement decays with distance and has a max propagation depth"
    - "Heat decays slowly over time (residual heat persistence)"
    - "Scorched earth and debris eventually recover (Nature Reclaims)"
    - "Ash is blown by Wind; Rubble is not"
    - "Earth cannot be displaced by Wind/Water, only transformed"
  artifacts:
    - path: "crates/omega-core/src/simulation/wind.rs"
      provides: "Wind force map with per-cell direction vectors"
      contains: "pub struct WindGrid"
    - path: "crates/omega-core/src/simulation/displacement.rs"
      provides: "Queue-based explosive displacement with max depth"
      contains: "pub fn apply_explosive_displacement"
    - path: "crates/omega-core/src/simulation/decay.rs"
      provides: "Nature Reclaims cycle and debris lifecycle"
      contains: "pub fn apply_nature_reclaims"
  key_links:
    - from: "crates/omega-core/src/simulation/wind.rs"
      to: "crates/omega-core/src/simulation/grid.rs"
      via: "WindGrid same dimensions as CaGrid, applied during update"
      pattern: "WindGrid.*width.*height"
    - from: "crates/omega-core/src/simulation/displacement.rs"
      to: "crates/omega-core/src/simulation/grid.rs"
      via: "Explosive displacement reads/writes CaGrid cells"
      pattern: "CaGrid"
---

<objective>
Implement advanced simulation mechanics: wind force maps that push gas and heat, explosive displacement for violent reactions, and the decay/Nature Reclaims lifecycle for persistence and recovery.

Purpose: These mechanics create the emergent behavior that makes the elemental system feel alive. Wind drives weather, explosions create chaos, and Nature Reclaims provides the long-term cycle. Without these, the simulation is reactive but not dynamic.
Output: Wind grid, explosive displacement queue, and decay/recovery systems, all unit-tested.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-elemental-system/01-CONTEXT.md
@.planning/phases/01-core-elemental-system/01-RESEARCH.md
@.planning/phases/01-core-elemental-system/01-01-SUMMARY.md
@.planning/phases/01-core-elemental-system/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Wind force map and explosive displacement</name>
  <files>
    crates/omega-core/src/simulation/wind.rs
    crates/omega-core/src/simulation/displacement.rs
    crates/omega-core/src/simulation/mod.rs
  </files>
  <action>
**Add `pub mod wind;` and `pub mod displacement;` to mod.rs.**

**`crates/omega-core/src/simulation/wind.rs`:** Wind as a force map (locked decision: Wind acts as a force map that pushes, pulls, or "cuts" Gas and Heat values).

Define:
```rust
#[derive(Debug, Clone, Copy, Default)]
pub struct WindVector {
    pub dx: i8,        // -1, 0, 1 direction
    pub dy: i8,        // -1, 0, 1 direction
    pub strength: u8,  // 0-255 force magnitude
}
```

```rust
pub struct WindGrid {
    width: usize,
    height: usize,
    vectors: Vec<WindVector>,
}
```

- `WindGrid::new(width, height) -> Self` — all vectors default (no wind).
- `WindGrid::get(&self, x, y) -> WindVector` — get wind at position.
- `WindGrid::set(&mut self, x, y, wind: WindVector)` — set wind at position.
- `WindGrid::set_global(&mut self, wind: WindVector)` — set uniform wind for all cells.

`pub fn apply_wind(grid: &CaGrid, wind: &WindGrid, x: usize, y: usize) -> Cell`:
- Get current cell and wind vector at (x, y).
- **Gas displacement:** If cell has gas AND wind strength > 50, push gas in wind direction. Set current cell gas to None, set target cell gas to current gas. Return modified cell with gas removed.
- **Heat push:** Wind carries heat in its direction. Reduce cell heat by `strength / 4`, increase target cell heat by same amount.
- **Debris interaction (locked decision):** If cell solid=Ash AND wind strength > 100, displace Ash in wind direction. Earth Anchoring: Earth, Stone, Mud, Rubble are NOT displaced by wind.
- **Gas dispersal ("cut"):** If wind strength > 200, dissipate gas faster (gas = None after shorter lifetime).
- Use saturating arithmetic throughout.

Unit tests:
- Wind pushes Steam in wind direction
- Wind pushes Ash but not Earth/Stone/Rubble (Earth Anchoring)
- Wind carries heat proportional to strength
- Zero wind = no effect
- Strong wind disperses gas faster

**`crates/omega-core/src/simulation/displacement.rs`:** Queue-based explosive displacement (locked decision: Violent reactions physically push Heat, Pressure, and Gasses into neighboring tiles in a single frame).

Define:
```rust
pub struct DisplacementEvent {
    pub origin_x: usize,
    pub origin_y: usize,
    pub heat: u8,
    pub pressure: u8,
    pub gas: Option<Gas>,
    pub radius: u8,       // Max propagation depth (hops)
    pub is_violent: bool,  // True for Fireballs, false for mundane
}
```

`pub fn apply_explosive_displacement(grid: &mut CaGrid, event: &DisplacementEvent)`:
- Use BFS (queue-based, not recursive) from origin outward, up to `radius` hops.
- At each hop: distribute heat and pressure evenly among reachable neighbors. Decay by 20% per hop.
- Push gas outward from center (set gas on frontier cells).
- Track "visited" cells to prevent feedback loops (use Vec<bool> or HashSet).
- Max depth: 5 hops for violent, 2 for non-violent (per research recommendation).
- Per hop: `heat_at_hop = event.heat * (0.8 ^ hop_distance)` (using integer math: multiply by 4, divide by 5 per hop).
- Per hop: `pressure_at_hop = event.pressure * (0.8 ^ hop_distance)`.

`pub fn check_explosion_trigger(cell: &Cell) -> Option<DisplacementEvent>`:
- If cell pressure > 200 AND gas=Fire AND solid is combustible -> trigger explosion (Combustion Mechanics: high combustible concentrations trigger pressure-based explosions).
- Return DisplacementEvent with radius=5, is_violent=true.

Unit tests:
- Explosion from center distributes heat to ring of neighbors
- Heat decays 20% per hop
- Max depth of 5 respected (no cells beyond radius affected)
- Visited cells not processed twice
- Explosion triggers when pressure > 200 with fire + combustible
- Non-violent displacement limited to radius 2
  </action>
  <verify>
Run `cargo test -p omega-core --lib simulation::wind` and `cargo test -p omega-core --lib simulation::displacement` — all tests pass. `cargo check -p omega-core` compiles clean.
  </verify>
  <done>
WindGrid provides per-cell force vectors that push Gas, Heat, and Ash (not Earth-anchored materials). Explosive displacement uses BFS queue with max depth, 20% decay per hop, and visited tracking. Explosion trigger detects high-pressure combustion. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement decay lifecycle and Nature Reclaims recovery</name>
  <files>
    crates/omega-core/src/simulation/decay.rs
    crates/omega-core/src/simulation/mod.rs
  </files>
  <action>
**Add `pub mod decay;` to mod.rs.**

**`crates/omega-core/src/simulation/decay.rs`:** Persistence, decay, and Nature Reclaims mechanics.

`pub fn apply_residual_decay(cell: &Cell) -> Cell`:
- Heat decays by 1 per tick (slow residual decay per locked decision: "Heat is Residual and decays slowly").
- Wet decays by 1 per tick if no liquid layer present (evaporation).
- Pressure decays by 2 per tick if no active source (gas=Fire).
- Smoke dissipates: if gas=Smoke, track internal counter. After ~10 ticks smoke clears.
- Use saturating_sub throughout.

Since cells are Copy types without internal counters, implement smoke/decay timing via a separate approach: add a `pub age: u8` field to Cell (or use a helper function that checks pressure/heat levels as proxy for "time since event"). To keep Cell lightweight, use a proxy approach: if gas=Smoke and heat < 20 and pressure < 20, clear smoke (the conditions that produced it have faded).

`pub fn apply_nature_reclaims(cell: &Cell) -> Cell`:
- Per locked decision: "Nature Reclaims" mechanic where scorched earth or debris eventually recovers.
- This runs at a slower rate than normal CA updates (caller decides frequency, e.g., every 60 ticks).
- **Ash recovery:** If solid=Ash AND heat < 10 AND wet > 50 -> solid=Earth (ash + moisture = fertile soil).
- **Rubble erosion:** If solid=Rubble AND wet > 100 -> solid=Earth (water erodes rubble over time).
- **Mud drying (long term):** If solid=Mud AND wet < 30 AND heat > 0 -> solid=Earth.
- **Gas clearing:** If gas=Steam AND heat < 50 -> gas=None (steam dissipates when cool).
- **Fire burnout:** If gas=Fire AND no combustible solid AND heat < 100 -> gas=None (fire without fuel dies).

`pub fn apply_full_decay_cycle(cell: &Cell, is_reclaim_tick: bool) -> Cell`:
- Applies residual_decay always.
- Applies nature_reclaims only when `is_reclaim_tick` is true.
- Chains: residual_decay -> conditional nature_reclaims.

Unit tests:
- Heat decays by 1 per tick
- Wet decays when no liquid present
- Pressure decays without active fire
- Smoke clears when heat and pressure low
- Ash recovers to Earth when cool and moist
- Rubble erodes to Earth when wet
- Fire burns out without fuel
- Steam dissipates when cool
- Nature Reclaims only applies on reclaim ticks
- Zero values don't underflow (saturating)
  </action>
  <verify>
Run `cargo test -p omega-core --lib simulation::decay` — all tests pass. Run `cargo test -p omega-core --lib simulation` — ALL simulation module tests pass. `cargo check -p omega-core` compiles clean.
  </verify>
  <done>
Residual decay provides slow, persistent heat/wet/pressure reduction. Nature Reclaims converts Ash->Earth, Rubble->Earth, clears old Steam/Smoke, and burns out fuelless Fire. Decay rates are gradual per the "Residual" locked decision. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `cargo test -p omega-core --lib simulation` — all tests pass (cell, state, grid, neighborhood, transitions, reactions, wind, displacement, decay)
- Wind pushes Gas and Heat but not Earth-anchored solids
- Explosive displacement uses BFS with max depth and decay
- Heat persists and decays slowly (residual)
- Nature Reclaims recovers scorched materials
- No infinite loops in displacement (visited tracking)
- `cargo check -p omega-core` compiles clean
</verification>

<success_criteria>
- WindGrid exists with per-cell wind vectors
- Wind displaces Gas, Heat, Ash but respects Earth Anchoring
- Explosive displacement BFS with 20% decay per hop, max depth 5
- Explosion triggers on pressure > 200 with fire + combustible
- Residual heat decays by 1 per tick
- Nature Reclaims: Ash->Earth (cool+moist), Rubble->Earth (wet), Fire burnout (no fuel)
- Smoke/Steam clear when source conditions fade
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-elemental-system/01-03-SUMMARY.md`
</output>
