---
phase: 02-projectile-ecs
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - crates/omega-bevy/src/simulation/systems.rs
  - crates/omega-core/src/simulation/displacement.rs
autonomous: true

must_haves:
  truths:
    - "Projectiles collide with obstacles based on Z-height"
    - "Projectiles collide with other projectiles (interception)"
    - "Impacts trigger CA grid changes and DisplacementEvents"
    - "Deflection causes projectiles to bounce"
---

<objective>
Implement collision detection and interception logic, connecting projectiles to the world and other projectiles.

Output: Collision and impact systems in omega-bevy.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Implement projectile collision with world and entities</name>
  <files>
    crates/omega-bevy/src/simulation/systems.rs
  </files>
  <action>
Implement `projectile_collision_system`:
- Check `logical_pos` against `CaGrid` tiles.
- If `logical_pos.z <= obstacle_height` (e.g. wall height=1.0, ground=0.0):
  - Trigger impact.
- Check against `Monster` entities.
- If hit:
  - Apply damage based on projectile properties.
  - Apply knockback using `Weight` stat.
  </action>
</task>

<task type="auto">
  <name>Task 2: Implement mid-air interception and deflection</name>
  <files>
    crates/omega-bevy/src/simulation/systems.rs
  </files>
  <action>
Implement `projectile_interception_system`:
- Check for overlaps between all pairs of `Projectile` entities.
- Compare `intensity`, `volume`, and `mass`:
  - Higher intensity "bats away" lower intensity.
  - Equal intensity: both negate (despawn).
  - Deflection: Change velocity vector of the "batted" projectile.
  </action>
</task>

<task type="auto">
  <name>Task 3: Trigger CA Impact</name>
  <files>
    crates/omega-bevy/src/simulation/systems.rs
  </files>
  <action>
On impact:
- Inject `heat`, `wet`, or `pressure` into the local `CaGrid` cell.
- If it's an explosion (e.g. Fireball), trigger `apply_explosive_displacement` from `omega-core`.
  </action>
</task>

</tasks>

<verification>
- `cargo check -p omega-bevy` passes
</verification>
