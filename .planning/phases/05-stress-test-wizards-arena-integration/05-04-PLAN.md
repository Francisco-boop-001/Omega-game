---
phase: 05-stress-test-wizards-arena-integration
plan: 04
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - crates/omega-tools/src/bin/arena_stress_test.rs
autonomous: false

must_haves:
  truths:
    - "Automated stress test validates 100+ projectiles at 60 FPS on 128x128 grid"
    - "CA grid updates complete within 2ms frame budget"
    - "Stress test produces pass/fail report with timing data"
  artifacts:
    - path: "crates/omega-tools/src/bin/arena_stress_test.rs"
      provides: "Automated headless stress test binary"
  key_links:
    - from: "crates/omega-tools/src/bin/arena_stress_test.rs"
      to: "crates/omega-bevy/src/simulation/plugin.rs"
      via: "SimulationPlugin with diagnostics"
      pattern: "SimulationPlugin"
    - from: "crates/omega-tools/src/bin/arena_stress_test.rs"
      to: "crates/omega-core/src/simulation/catastrophe.rs"
      via: "Catastrophe scenario triggering"
      pattern: "Catastrophe::"
---

<objective>
Create an automated headless stress test binary and verify the complete arena system meets performance targets.

Purpose: Satisfy TEST-03 (100+ projectiles, 128x128 grid, 60 FPS) with a repeatable automated benchmark. Provide final integration verification.
Output: arena_stress_test binary that runs headless Bevy app, spawns stress scenarios, measures performance, and reports pass/fail.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-stress-test-wizards-arena-integration/05-01-SUMMARY.md
@.planning/phases/05-stress-test-wizards-arena-integration/05-02-SUMMARY.md
@crates/omega-bevy/src/simulation/plugin.rs
@crates/omega-bevy/src/simulation/diagnostics.rs
@crates/omega-core/src/simulation/catastrophe.rs
@crates/omega-tools/src/bin/perf_baseline.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create automated arena stress test binary</name>
  <files>crates/omega-tools/src/bin/arena_stress_test.rs</files>
  <action>
Create `arena_stress_test.rs` as a headless Bevy application that runs stress scenarios and validates performance targets.

Structure:
1. **Setup**: Create headless Bevy App with `MinimalPlugins`, `SimulationPlugin::new(128, 128)` (128x128 grid per TEST-03 requirement).

2. **Test scenarios** (run sequentially, each scenario runs for N FixedUpdate ticks):

   a. **Baseline** (200 ticks): Empty grid, no projectiles. Record average CA update time as baseline.

   b. **100+ Projectiles** (400 ticks):
      - Enable TurretMode with `fire_rate_hz: 50.0` (high rate to quickly reach 100+).
      - After 100 ticks, count projectile entities. Must be >= 100.
      - Measure FPS equivalent: check that each FixedUpdate tick completes in <15.6ms (64Hz budget).
      - Read CA_UPDATE_TIME diagnostic: must be <2ms average.

   c. **Catastrophe Suite** (200 ticks per catastrophe):
      - Trigger each catastrophe individually: great_flood, forest_fire_jump, massive_windstorm, fuel_field.
      - Run 200 ticks after each.
      - Verify CA update time stays <2ms.

   d. **Doomsday + Turret** (400 ticks):
      - Trigger doomsday (all catastrophes).
      - Enable turret at 20Hz.
      - This is the worst-case scenario.
      - Measure average FixedUpdate time and CA update time.

   e. **Emergency Recovery** (200 ticks):
      - After doomsday + turret, check if SafetyConfig triggered emergency.
      - If yes, verify cleanup happened (gas/liquid cells cleared).
      - Verify system recovers (CA update time drops after cleanup).

3. **Measurement approach**:
   - Use `app.update()` in a loop to advance the app by one frame.
   - After each update, read `DiagnosticsStore` for CA_UPDATE_TIME and FPS metrics.
   - Collect measurements into vectors for statistical analysis.
   - Compute: average, p95, p99, max for CA timing and frame time.

4. **Report output** (println to stdout):
   ```
   === Arena Stress Test Report ===

   Scenario: Baseline (128x128 grid, empty)
     CA Update: avg={:.2}ms  p95={:.2}ms  max={:.2}ms
     Result: PASS/FAIL (target: <2ms)

   Scenario: 100+ Projectiles
     Peak Projectile Count: {n}
     CA Update: avg={:.2}ms  p95={:.2}ms  max={:.2}ms
     Frame Time: avg={:.2}ms  p95={:.2}ms
     Result: PASS/FAIL (target: <2ms CA, <16.6ms frame)

   ... (one section per scenario)

   === OVERALL: PASS/FAIL ===
   ```

5. **Exit code**: 0 if all pass, 1 if any fail.

6. **Important implementation notes**:
   - Use `bevy::app::ScheduleRunnerPlugin::run_loop(Duration::ZERO)` for headless mode - OR simply call `app.update()` in a manual loop.
   - Do NOT use windowed/render plugins.
   - The FrameTimeDiagnosticsPlugin requires a few warmup frames before diagnostics are available. Skip first 20 frames.
   - For timing, also use `std::time::Instant` around `app.update()` as a secondary measurement independent of Bevy diagnostics.

Follow the pattern of existing omega-tools binaries (e.g., `perf_baseline.rs`) for structure and output formatting.
  </action>
  <verify>
`cargo build -p omega-tools --bin arena_stress_test` compiles.
`cargo run -p omega-tools --bin arena_stress_test` produces a report.
  </verify>
  <done>
Automated stress test binary runs 5 scenarios (baseline, 100+ projectiles, catastrophe suite, doomsday+turret, emergency recovery), measures CA timing and frame time, reports pass/fail against targets (<2ms CA, <16.6ms frame, >=100 projectiles).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify arena integration end-to-end</name>
  <files>none</files>
  <action>
Verify the complete Wizard's Arena integration: catastrophe scenarios, performance diagnostics, TUI arena controls, Bevy arena controls, snapshot/restore, turret mode, emergency safety, and automated stress test.

Steps:
1. Run `cargo run -p omega-tools --bin arena_stress_test` and confirm PASS result.
2. Run `cargo run -p omega-tui` and select Wizard's Arena (option 3):
   - Press 1-5 to trigger catastrophe scenarios. Verify grid changes visually.
   - Press F/W/A to switch brush modes. Click on map to paint elements.
   - Press S to snapshot, trigger a catastrophe, press R to restore.
   - Press T to toggle turret mode. Verify projectiles appear.
   - Press L to toggle event log.
   - Verify performance HUD shows FPS, CA timing, counters.
3. Run `cargo run -p omega-bevy` (if graphical available):
   - Enter Wizard's Arena from menu.
   - Check "Arena Controls" egui window appears with buttons.
   - Test catastrophe buttons, turret toggle, snapshot controls.
4. All `cargo test` in workspace pass.
  </action>
  <verify>All scenarios above produce expected results. Stress test exits with code 0.</verify>
  <done>User has verified arena integration works end-to-end in both TUI and Bevy frontends. Stress test passes. Phase 5 complete.</done>
</task>

</tasks>

<verification>
- `cargo run -p omega-tools --bin arena_stress_test` exits with code 0.
- CA grid updates average <2ms on 128x128 grid.
- 100+ projectiles can exist simultaneously.
- Emergency cleanup triggers and recovers correctly.
- TUI and Bevy arena controls are functional.
- All workspace tests pass.
</verification>

<success_criteria>
- TEST-03 satisfied: Stress test validates 100+ projectiles and 128x128 grid at 60 FPS.
- TEST-01 satisfied: Wizard's Arena scene allows testing all elemental combinations.
- TEST-02 satisfied: Performance monitoring for CA grid updates works.
- Phase 5 success criteria met: Arena scene functional, 60 FPS with 100+ projectiles, <2ms CA updates.
</success_criteria>

<output>
After completion, create `.planning/phases/05-stress-test-wizards-arena-integration/05-04-SUMMARY.md`
</output>
