---
phase: 05-stress-test-wizards-arena-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/omega-bevy/src/simulation/diagnostics.rs
  - crates/omega-bevy/src/simulation/mod.rs
  - crates/omega-bevy/src/simulation/plugin.rs
  - crates/omega-bevy/src/simulation/systems.rs
autonomous: true

must_haves:
  truths:
    - "CA grid update time is measured and reported as a Bevy diagnostic"
    - "Performance snapshot data is available as a Bevy Resource for HUD consumption"
    - "Event log captures elemental reaction descriptions"
  artifacts:
    - path: "crates/omega-bevy/src/simulation/diagnostics.rs"
      provides: "CaDiagnosticsPlugin, PerfSnapshot resource, ReactionLog event"
      exports: ["CaDiagnosticsPlugin", "PerfSnapshot", "ReactionLog"]
  key_links:
    - from: "crates/omega-bevy/src/simulation/diagnostics.rs"
      to: "crates/omega-bevy/src/simulation/systems.rs"
      via: "Timing measurement wrapping environmental_behaviors"
      pattern: "Instant::now"
    - from: "crates/omega-bevy/src/simulation/diagnostics.rs"
      to: "bevy::diagnostic"
      via: "DiagnosticPath registration"
      pattern: "DiagnosticPath"
---

<objective>
Implement performance diagnostics: custom CA timing diagnostic, centralized PerfSnapshot resource, and reaction event logging.

Purpose: Satisfy TEST-02 (performance monitoring for CA grid updates) and provide data pipeline for the TUI performance HUD.
Output: CaDiagnosticsPlugin that measures CA update time, maintains PerfSnapshot with all arena metrics, and logs elemental reactions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/omega-bevy/src/simulation/plugin.rs
@crates/omega-bevy/src/simulation/systems.rs
@crates/omega-bevy/src/simulation/particles.rs
@crates/omega-bevy/src/simulation/projectiles.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CaDiagnosticsPlugin with PerfSnapshot and ReactionLog</name>
  <files>
    crates/omega-bevy/src/simulation/diagnostics.rs
    crates/omega-bevy/src/simulation/mod.rs
  </files>
  <action>
Create `diagnostics.rs` with:

1. **Diagnostic paths** (const):
   - `CA_UPDATE_TIME: DiagnosticPath = DiagnosticPath::const_new("ca/update_ms")` - CA grid update timing.
   - `FIXED_UPDATE_TIME: DiagnosticPath = DiagnosticPath::const_new("fixed_update/total_ms")` - Total FixedUpdate timing.

2. **PerfSnapshot** Resource (updated every 10 FixedUpdate ticks to avoid overhead):
   ```rust
   #[derive(Resource, Default)]
   pub struct PerfSnapshot {
       pub fps: f64,
       pub ca_update_ms: f64,
       pub fixed_update_ms: f64,
       pub projectile_count: usize,
       pub particle_count: usize,
       pub active_cells: usize,     // Non-empty cells in CA grid
       pub event_log: Vec<String>,   // Last 20 reaction events
       pub show_logs: bool,          // Toggle for collapsible panel
       pub in_emergency: bool,       // From SafetyConfig
   }
   ```

3. **ReactionLog** Event:
   ```rust
   #[derive(Event)]
   pub struct ReactionLog {
       pub description: String,  // e.g., "Fireball hit Water -> Generated 15 Steam cells"
   }
   ```

4. **Systems:**

   - `measure_ca_timing_system` - Runs in FixedUpdate, wraps `environmental_behaviors`:
     Actually, do NOT wrap the existing system. Instead, measure timing AROUND the environmental_behaviors call by recording `Instant::now()` before and after in a separate before/after system pair:
     - `ca_timing_start` system: stores `Instant::now()` in a `Local<Option<Instant>>` or a `CaTimingStart` resource.
     - `ca_timing_end` system: reads start time, computes elapsed, adds measurement to `Diagnostics`.
     Place `ca_timing_start` `.before(environmental_behaviors)` and `ca_timing_end` `.after(swap_ca_buffers)` in the FixedUpdate schedule.
     Use `CaTimingState` Resource to store the start instant:
     ```rust
     #[derive(Resource, Default)]
     pub struct CaTimingState {
         pub start: Option<std::time::Instant>,
     }
     ```

   - `update_perf_snapshot_system` - Runs in Update schedule (once per frame):
     1. Read FPS from `DiagnosticsStore` via `FrameTimeDiagnosticsPlugin::FPS`.
     2. Read CA timing from `DiagnosticsStore` via `CA_UPDATE_TIME`.
     3. Count projectiles: `projectiles.iter().count()` with `Query<&Projectile>`.
     4. Count particles: `particles.iter().count()` with `Query<&Particle>`.
     5. Count active cells: iterate CaGrid, count cells where `!cell.is_empty()`.
     6. Read `SafetyConfig.in_emergency` (use `Option<Res<SafetyConfig>>` in case Plan 01 hasn't run yet).
     7. Update PerfSnapshot resource.

   - `collect_reaction_logs_system` - Runs in Update:
     1. Read `EventReader<ReactionLog>` events.
     2. Push descriptions to `PerfSnapshot.event_log`.
     3. Trim to last 20 entries.

5. **CaDiagnosticsPlugin**:
   ```rust
   impl Plugin for CaDiagnosticsPlugin {
       fn build(&self, app: &mut App) {
           app.register_diagnostic(Diagnostic::new(CA_UPDATE_TIME).with_max_history_length(20))
              .register_diagnostic(Diagnostic::new(FIXED_UPDATE_TIME).with_max_history_length(20))
              .insert_resource(PerfSnapshot::default())
              .insert_resource(CaTimingState::default())
              .add_event::<ReactionLog>()
              .add_systems(Update, (update_perf_snapshot_system, collect_reaction_logs_system));
           // NOTE: ca_timing_start and ca_timing_end are added to FixedUpdate
           // but must be ordered relative to existing systems in SimulationPlugin.
           // So export them for SimulationPlugin to integrate.
       }
   }
   ```

   Actually, since FixedUpdate ordering needs to reference existing systems, export `ca_timing_start` and `ca_timing_end` as public functions and let SimulationPlugin add them with proper ordering.

Update `mod.rs` to add `pub mod diagnostics;`.
  </action>
  <verify>
`cargo check -p omega-bevy` compiles clean.
  </verify>
  <done>
CaDiagnosticsPlugin registers CA_UPDATE_TIME diagnostic, PerfSnapshot resource with FPS/projectile/particle counts, and ReactionLog event system. Timing systems exported for FixedUpdate integration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate diagnostics timing into SimulationPlugin FixedUpdate chain</name>
  <files>
    crates/omega-bevy/src/simulation/plugin.rs
    crates/omega-bevy/src/simulation/systems.rs
  </files>
  <action>
Update `plugin.rs`:
1. Import CaDiagnosticsPlugin, ca_timing_start, ca_timing_end from diagnostics module.
2. Add `.add_plugins(CaDiagnosticsPlugin)` in SimulationPlugin::build.
3. Modify the FixedUpdate system chain to insert timing measurement:
   - Add `ca_timing_start` before `update_ca_cells` in the chain.
   - Add `ca_timing_end` after `swap_ca_buffers` in the chain.
   - The chain becomes: `..., projectile_interception_system, ca_timing_start, update_ca_cells, process_explosions, environmental_behaviors, swap_ca_buffers, ca_timing_end`.

Update `systems.rs` - Add reaction logging to `projectile_collision_system`:
1. Add `EventWriter<ReactionLog>` parameter.
2. When a projectile impacts the grid and modifies cells, emit a ReactionLog event describing the impact:
   - Format: `"{element} impact at ({x},{y}) -> heat:{h} wet:{w} pressure:{p}"` where element is derived from the impact cell's dominant property.
3. When explosive displacement triggers (pressure > 200), log: `"Explosive displacement at ({x},{y}) radius:3"`.
  </action>
  <verify>
`cargo check -p omega-bevy` compiles clean.
`cargo test -p omega-bevy` passes existing tests.
  </verify>
  <done>
CA timing measurement wraps the core simulation chain in FixedUpdate. Projectile collisions emit ReactionLog events describing elemental impacts. PerfSnapshot updates every frame with live metrics.
  </done>
</task>

</tasks>

<verification>
- `cargo check -p omega-bevy` compiles clean with diagnostics integrated.
- `cargo test -p omega-bevy` passes all tests.
- PerfSnapshot resource is populated with FPS, CA timing, projectile/particle counts.
- ReactionLog events fire on projectile impacts.
- CA timing diagnostic measures from update_ca_cells through swap_ca_buffers.
</verification>

<success_criteria>
- CA grid update time is measured and available via Bevy DiagnosticsStore at path "ca/update_ms".
- PerfSnapshot resource provides all metrics needed for HUD rendering.
- Reaction events are logged and stored in PerfSnapshot.event_log (max 20).
- TEST-02 requirement (performance monitoring for CA grid updates) is satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/05-stress-test-wizards-arena-integration/05-02-SUMMARY.md`
</output>
