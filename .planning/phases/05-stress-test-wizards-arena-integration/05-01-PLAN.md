---
phase: 05-stress-test-wizards-arena-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/omega-core/src/simulation/catastrophe.rs
  - crates/omega-core/src/simulation/snapshot.rs
  - crates/omega-core/src/simulation/mod.rs
  - crates/omega-bevy/src/simulation/turret.rs
  - crates/omega-bevy/src/simulation/safety.rs
  - crates/omega-bevy/src/simulation/mod.rs
  - crates/omega-bevy/src/simulation/plugin.rs
autonomous: true

must_haves:
  truths:
    - "Catastrophe scenarios (flood, fire, windstorm, doomsday) can be triggered programmatically"
    - "Arena state can be snapshot and restored to pre-disaster state"
    - "Turret mode automatically fires random projectiles at configurable rate"
    - "Emergency cleanup triggers when FPS drops below critical threshold with hysteresis"
  artifacts:
    - path: "crates/omega-core/src/simulation/catastrophe.rs"
      provides: "Catastrophe scenario builders (great_flood, forest_fire_jump, massive_windstorm, fuel_field, doomsday)"
      exports: ["Catastrophe"]
    - path: "crates/omega-core/src/simulation/snapshot.rs"
      provides: "Arena snapshot capture and restore with max 5 history"
      exports: ["ArenaSnapshot", "SnapshotManager"]
    - path: "crates/omega-bevy/src/simulation/turret.rs"
      provides: "Automated turret mode resource and system"
      exports: ["TurretMode", "turret_mode_system"]
    - path: "crates/omega-bevy/src/simulation/safety.rs"
      provides: "Emergency cleanup system with tiered thresholds and hysteresis"
      exports: ["SafetyConfig", "emergency_cleanup_system"]
  key_links:
    - from: "crates/omega-core/src/simulation/catastrophe.rs"
      to: "crates/omega-core/src/simulation/grid.rs"
      via: "CaGrid mutation"
      pattern: "CaGrid"
    - from: "crates/omega-bevy/src/simulation/turret.rs"
      to: "crates/omega-bevy/src/simulation/projectiles.rs"
      via: "Projectile spawning"
      pattern: "Projectile"
    - from: "crates/omega-bevy/src/simulation/safety.rs"
      to: "crates/omega-core/src/simulation/grid.rs"
      via: "Emergency grid clearing"
      pattern: "CaGrid"
---

<objective>
Implement core arena systems: catastrophe scenario builders, snapshot/restore, turret mode, and emergency safety mechanisms.

Purpose: Provide the programmatic foundation for stress testing all elemental interactions. These systems are invoked by both TUI controls and automated stress tests.
Output: Four new modules (catastrophe, snapshot in omega-core; turret, safety in omega-bevy) registered in SimulationPlugin.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@crates/omega-core/src/simulation/grid.rs
@crates/omega-core/src/simulation/wind.rs
@crates/omega-core/src/simulation/cell.rs
@crates/omega-core/src/simulation/environmental.rs
@crates/omega-core/src/simulation/mod.rs
@crates/omega-bevy/src/simulation/plugin.rs
@crates/omega-bevy/src/simulation/systems.rs
@crates/omega-bevy/src/simulation/projectiles.rs
@crates/omega-bevy/src/simulation/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement catastrophe scenarios and snapshot system in omega-core</name>
  <files>
    crates/omega-core/src/simulation/catastrophe.rs
    crates/omega-core/src/simulation/snapshot.rs
    crates/omega-core/src/simulation/mod.rs
  </files>
  <action>
Create `catastrophe.rs` with a `Catastrophe` struct providing these public methods, all operating on `&mut CaGrid` and/or `&mut WindGrid`:

1. `great_flood(grid: &mut CaGrid, center: (usize, usize))` - Sets `wet=100` and `liquid=Some(Liquid::Water)` in a 15-cell radius around center.
2. `forest_fire_jump(grid: &mut CaGrid, origin: (usize, usize))` - Sets `heat=200` and `gas=Some(Gas::Fire)` in a 20-cell radius around origin.
3. `massive_windstorm(wind_grid: &mut WindGrid)` - Sets all wind vectors to `WindVector { dx: 1, dy: -1, strength: 200 }` (hurricane-force).
4. `fuel_field(grid: &mut CaGrid)` - Fills entire grid with `solid=Some(Solid::Wood)` except a 5-cell border of Stone walls.
5. `doomsday(grid: &mut CaGrid, wind_grid: &mut WindGrid)` - Calls great_flood (center), forest_fire_jump (quarter), massive_windstorm, and fuel_field sequentially.

All radius operations should clamp to grid bounds using `saturating_sub` and `min(grid.width()/height())`.

Create `snapshot.rs` with:
- `ArenaSnapshot` struct holding a cloned `Vec<Cell>` (front buffer), grid dimensions, and a `String` label.
- `ArenaSnapshot::capture(grid: &CaGrid, label: String) -> Self` - Clones front buffer.
- `ArenaSnapshot::restore(&self, grid: &mut CaGrid)` - Copies cells back into grid's front buffer. Add a `pub fn load_front_buffer(&mut self, cells: &[Cell])` method to CaGrid for this.
- `SnapshotManager` struct with `Vec<ArenaSnapshot>` and `max_snapshots: usize` (default 5).
- `SnapshotManager::push(snapshot)` - Adds snapshot, removes oldest if over max.
- `SnapshotManager::pop() -> Option<ArenaSnapshot>` - Returns most recent.
- `SnapshotManager::list() -> &[ArenaSnapshot]` - Returns all labels.

Update `mod.rs` to add `pub mod catastrophe;` and `pub mod snapshot;`.

Include unit tests in both files:
- Catastrophe: verify great_flood sets wet values, forest_fire_jump sets heat, fuel_field places wood.
- Snapshot: verify capture/restore roundtrip preserves cell state, push respects max limit.
  </action>
  <verify>
`cargo test -p omega-core --lib simulation::catastrophe` and `cargo test -p omega-core --lib simulation::snapshot` pass.
`cargo check -p omega-core` compiles clean.
  </verify>
  <done>
Catastrophe module provides 5 scenario builders that mutate CaGrid/WindGrid. Snapshot module captures and restores grid state with max-5 history. Both compile and pass unit tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement turret mode and emergency safety systems in omega-bevy</name>
  <files>
    crates/omega-bevy/src/simulation/turret.rs
    crates/omega-bevy/src/simulation/safety.rs
    crates/omega-bevy/src/simulation/mod.rs
    crates/omega-bevy/src/simulation/plugin.rs
  </files>
  <action>
Create `turret.rs`:
- `TurretMode` Resource with fields: `active: bool`, `fire_rate_hz: f32` (default 5.0), `accumulator: f32`.
- `turret_mode_system` Bevy system that:
  1. Returns early if `!turret.active`.
  2. Accumulates `time.delta_secs()`, fires projectile each `1.0 / fire_rate_hz` interval.
  3. Uses `rand::thread_rng()` to pick random origin (x,y) and target (x,y) within grid bounds.
  4. Randomly selects element impact from 3 presets: fire (heat=200, gas=Fire), water (wet=100, liquid=Water), explosive (pressure=250).
  5. Computes velocity vector from origin to target with TrajectoryMode::HighArc. Set z velocity to ~15.0 for arc.
  6. Spawns `Projectile` component + `Transform` via `commands.spawn(...)`.
  7. Uses `CaGrid` resource to read grid dimensions for bounds.

Create `safety.rs`:
- `SafetyConfig` Resource: `cleanup_threshold_fps: f64` (20.0), `recovery_threshold_fps: f64` (30.0), `cooldown_secs: f32` (5.0), `particle_cap: usize` (500), `in_emergency: bool`, `cooldown_timer: f32`.
- `emergency_cleanup_system` Bevy system:
  1. Read FPS from `DiagnosticsStore` using `FrameTimeDiagnosticsPlugin::FPS`.
  2. If `!in_emergency && fps < cleanup_threshold_fps`:
     - Set `in_emergency = true`, reset cooldown timer.
     - Clear all gas and liquid from CaGrid (iterate all cells, set gas=None, liquid=None, pressure=0, wet=0).
     - Despawn all `Particle` entities beyond particle_cap (query, sort by age, despawn oldest).
     - Log warning with `warn!()`.
  3. If `in_emergency`:
     - Decrement cooldown timer.
     - If `fps > recovery_threshold_fps && cooldown_timer <= 0.0`: set `in_emergency = false`.
  4. Enforce hard particle cap every frame: if particle count > cap, despawn oldest by `particle.age`.
- `particle_cap_system` separate system (runs every frame, not just emergency): counts particles, despawns excess oldest.

Update `mod.rs` to add `pub mod turret;` and `pub mod safety;`.

Update `plugin.rs`:
- Import TurretMode, turret_mode_system, SafetyConfig, emergency_cleanup_system, particle_cap_system.
- Add `FrameTimeDiagnosticsPlugin` to app (`.add_plugins(FrameTimeDiagnosticsPlugin)`).
- Insert TurretMode::default() and SafetyConfig::default() as resources.
- Add turret_mode_system to FixedUpdate chain (after projectile_interception_system, before update_ca_cells).
- Add emergency_cleanup_system and particle_cap_system to Update schedule (not FixedUpdate - FPS diagnostics update per frame).
  </action>
  <verify>
`cargo check -p omega-bevy` compiles clean.
`cargo test -p omega-bevy` passes (existing tests still pass).
  </verify>
  <done>
TurretMode resource and system spawn random projectiles when active. SafetyConfig enforces tiered emergency cleanup with hysteresis (cleanup <20 FPS, recover >30 FPS, 5s cooldown). Hard particle cap despawns oldest particles. All registered in SimulationPlugin.
  </done>
</task>

</tasks>

<verification>
- `cargo check -p omega-core -p omega-bevy` compiles clean.
- `cargo test -p omega-core` passes all simulation tests including new catastrophe and snapshot tests.
- `cargo test -p omega-bevy` passes all tests.
- CaGrid has new `load_front_buffer` method for snapshot restore.
- SimulationPlugin registers FrameTimeDiagnosticsPlugin, TurretMode, SafetyConfig.
</verification>

<success_criteria>
- Catastrophe scenarios can be triggered programmatically against CaGrid/WindGrid.
- Snapshots capture and restore grid state with max-5 limit.
- Turret mode spawns random projectiles at configurable rate.
- Emergency cleanup activates at FPS < 20, recovers at FPS > 30 with cooldown.
- Hard particle cap enforced every frame.
</success_criteria>

<output>
After completion, create `.planning/phases/05-stress-test-wizards-arena-integration/05-01-SUMMARY.md`
</output>
